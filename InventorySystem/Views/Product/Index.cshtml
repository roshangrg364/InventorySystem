@model Product
@{
    ViewData["Title"] = "Product";

    Layout = "~/Views/Shared/_Layout.cshtml";

}
@section styles{
    <style>
        .my-custom-scrollbar {
            position: relative;
            height: 200px;
            overflow: auto;
        }

        .table-wrapper-scroll-y {
            display: block;
        }
    </style>
}

<div class="container-fluid">
    <div class="text-center">
        <h2> Product Entry</h2>
    </div>
    <div class="row">
        <div class="col-md-4">
            <form method="post" class="save-data">
                <div class="form-group">
                    @Html.HiddenFor(a => a.p_id, new { @class = "p_id" })
                    <a asp-controller="Category" asp-action="Index" class="btn btn-primary btn-sm float-right">Add</a>
                    @Html.DisplayNameFor(a => a.cat_id)
                    @Html.DropDownListFor(a => a.cat_id, new SelectList(ViewBag.categories, "cat_id", "category"), new { @class = "form-control category" })
                    @Html.ValidationMessageFor(a => a.cat_id, "", new { @class = "text-danger" })
                </div>

                <div class="form-group">
                    @Html.DisplayNameFor(a => a.product)
                    @Html.TextBoxFor(a => a.product, new { @class = "form-control product" })
                    @Html.ValidationMessageFor(a => a.product, "", new { @class = "text-danger " })
                </div>

                <div class="form-group">
                    @Html.DisplayNameFor(a => a.qty)
                    @Html.TextBoxFor(a => a.qty, new { @class = "form-control qty" })
                    @Html.ValidationMessageFor(a => a.qty, "", new { @class = "text-danger " })
                </div>

                <div class="form-group">
                    @Html.DisplayNameFor(a => a.price)
                    @Html.TextBoxFor(a => a.price, new { @class = "form-control price" })
                    @Html.ValidationMessageFor(a => a.price, "", new { @class = "text-danger " })
                </div>

                <div class="form-group">
                    <button type="submit" class="btn btn-primary btn-save btn-sm">Save</button>
                    <button class="btn btn-primary btn-sm">back</button>
                    <button type="submit" class="btn btn-primary btn-clear btn-sm">clear</button>
                </div>
                <div class="msg bg-success text-white text-center"></div>
            </form>
        </div>

        <div class="col-md-8">
            <table class="table table-wrapper-scroll-y my-custom-scrollbar">

                <tr>
                    <th style="display:none;"> @Html.DisplayNameFor(a => a.p_id)</th>
                    <th> @Html.DisplayNameFor(a => a.cat_id)</th>
                    <th> @Html.DisplayNameFor(a => a.product)</th>
                    <th> @Html.DisplayNameFor(a => a.qty)</th>
                    <th> @Html.DisplayNameFor(a => a.price)</th>

                    <th>Actions</th>
                </tr>

                @{
                    foreach (var product in (ViewBag.products as List<Product>))
                    {
                        <tr>
                            <td style="display:none;">@product.p_id</td>
                            <td>@product.catvalue.category</td>
                            <td>@product.product</td>
                            <td>@product.qty</td>
                            <td>@product.price</td>
                            <td>
                                <a data-id="@product.p_id" class="btn btn-info btn-sm btn-edit">Edit</a>
                                <a data-id="@product.p_id" class="btn btn-danger btn-sm btn-delete">Delete</a>
                            </td>

                        </tr>
                    }
                }
            </table>
        </div>

    </div>
</div>
@section scripts{
    <script>

        $(document).ready(function () {
            $('.btn-save').on('click', function () {
                event.preventDefault();
                $('.save-data').validate();

                $.ajax(
                    {
                        url: '/product/AddProduct',
                        type: 'post',
                        dataType: 'json',
                        data: $('.save-data').serialize(),
                        success: function (data, status) {
                            var category = $('.category option:selected').text();
                            var product = $('.product').val();
                            var qty = $('.qty').val();
                            var price = $('.price').val();
                            var p_id = $('.p_id').val();
                            if (p_id == 0) {
                                $('.table').append(
                                    `
                                    <tr>
                                    <td style="display:none;">${data.id}</td>
                                    <td>${category}</td>
                                    <td>${product}</td>
                                    <td>${qty}</td>
                                    <td>${price}</td>
                                    <td>
                                        <a data-id=${data.p_id} class="btn btn-info btn-sm btn-edit">Edit</a>
                                       <a data-id=${data.p_id} class="btn btn-danger btn-sm btn-delete">Delete</a>
                                    </td>

                                </tr>
                                `)
                                $('.msg').html("Product added Successfully")
                            }
                            else {
                                $('.table tr').each(function () {
                                    var id = $(this).find('td').eq(0).text();
                                    if (id == p_id) {
                                        $(this).find('td').eq(1).text(category);
                                        $(this).find('td').eq(2).text(product);
                                        $(this).find('td').eq(3).text(qty);
                                        $(this).find('td').eq(4).text(price);
                                    }
                                    $('.msg').html("Updated Successfully");
                                })
                            }
                        }
                    })
            })

            $('body').delegate('.btn-edit', 'click', function () {
                event.preventDefault();
                var id = $(this).data('id');
                var url = `/product/Edit?id=${id}`;
                $.ajax
                    ({
                        url: url,
                        dataType: 'json',
                        type: 'get',
                        success: function (data, status) {
                            $('.p_id').val(data.p_id);
                            $('.category').val(data.cat_id);
                            $('.product').val(data.product);
                            $('.qty').val(data.qty);
                            $('.price').val(data.price);
                        }
                    });
            });


            $('body').delegate('.btn-delete', 'click', function (e) {
                e.preventDefault();
                var id = $(this).data('id');
                var url = `/product/Delete?id=${id}`;
                var delete_btn = $(this);
                $.ajax(
                    {
                        url: url,
                        type: 'get',
                        beforeSend: function () {
                            return confirm("do you want to delete?");
                        },
                        success: function (data, status) {
                            $(delete_btn).closest('tr').remove();
                            $('.msg').html("Deleted Successfully");
                        }
                    }
                )
            }
            )

            $('.btn-clear').on('click', function () {
                event.preventDefault();
                $('.p_id').val('');
                $('.product').val('');
                $('.qty').val('');
                $('.price').val('');
            })

        });

    </script>
}